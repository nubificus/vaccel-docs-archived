
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Instructions to use vAccel in Unikraft">
      
      
      
        <meta name="author" content="Charalampos Mainas">
      
      
      <link rel="shortcut icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.1.2, mkdocs-material-6.2.8">
    
    
      
        <title>How to run a vAccel application using Unikraft - vAccel</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.cb6bc1d0.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.39b8e14a.min.css">
        
      
    
    
    
      
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>body,input{font-family:"Roboto",-apple-system,BlinkMacSystemFont,Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono",SFMono-Regular,Consolas,Menlo,monospace}</style>
      
    
    
    
      <link rel="stylesheet" href="../../stylesheets/extra.css">
    
    
      
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="none" data-md-color-accent="none">
      
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#setting-up-vaccert-for-the-host" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid" aria-label="Header">
    <a href="../.." title="vAccel" class="md-header-nav__button md-logo" aria-label="vAccel">
      
  <img src="../../img/vaccel-logo.png" alt="logo">

    </a>
    <label class="md-header-nav__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header-nav__title" data-md-component="header-title">
      <div class="md-header-nav__ellipsis">
        <div class="md-header-nav__topic">
          <span class="md-ellipsis">
            vAccel
          </span>
        </div>
        <div class="md-header-nav__topic">
          <span class="md-ellipsis">
            
              How to run a vAccel application using Unikraft
            
          </span>
        </div>
      </div>
    </div>
    
      <label class="md-header-nav__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" data-md-state="active" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <button type="reset" class="md-search__icon md-icon" aria-label="Clear" data-md-component="search-reset" tabindex="-1">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    




<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="vAccel" class="md-nav__button md-logo" aria-label="vAccel">
      
  <img src="../../img/vaccel-logo.png" alt="logo">

    </a>
    vAccel
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        Home
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../quickstart/" class="md-nav__link">
        Quickstart
      </a>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="nav-3" type="checkbox" id="nav-3" >
      
      <label class="md-nav__link" for="nav-3">
        User Guide
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="User Guide" data-md-level="1">
        <label class="md-nav__title" for="nav-3">
          <span class="md-nav__icon md-icon"></span>
          User Guide
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../vaccelrt/" class="md-nav__link">
        Building the vAccel Runtime
      </a>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="nav-3-2" type="checkbox" id="nav-3-2" >
      
      <label class="md-nav__link" for="nav-3-2">
        Plugins
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Plugins" data-md-level="2">
        <label class="md-nav__title" for="nav-3-2">
          <span class="md-nav__icon md-icon"></span>
          Plugins
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../jetson/" class="md-nav__link">
        Jetson-inference
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../virtio/" class="md-nav__link">
        Virtio Accel
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../coral/" class="md-nav__link">
        Google Coral TPU
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../run/" class="md-nav__link">
        Running a simple example
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../kata-vaccel/" class="md-nav__link">
        vAccel on kata containers
      </a>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="nav-5" type="checkbox" id="nav-5" >
      
      <label class="md-nav__link" for="nav-5">
        k8s
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="k8s" data-md-level="1">
        <label class="md-nav__title" for="nav-5">
          <span class="md-nav__icon md-icon"></span>
          k8s
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../devmapper/" class="md-nav__link">
        Devmapper
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../k8s/kata/" class="md-nav__link">
        vAccel on k8s using Kata-containers & Firecracker
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="nav-6" type="checkbox" id="nav-6" checked>
      
      <label class="md-nav__link" for="nav-6">
        Unikernels
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Unikernels" data-md-level="1">
        <label class="md-nav__title" for="nav-6">
          <span class="md-nav__icon md-icon"></span>
          Unikernels
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
          
            
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          How to run a vAccel application using Unikraft
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        How to run a vAccel application using Unikraft
      </a>
      
        
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#setting-up-vaccert-for-the-host" class="md-nav__link">
    Setting up vAccert for the host
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#build-qemu-with-vaccel-support" class="md-nav__link">
    Build QEMU with vAccel support
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#build-the-unikraft-application" class="md-nav__link">
    Build the Unikraft application
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#fire-it-up" class="md-nav__link">
    Fire it up!
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../examples/" class="md-nav__link">
        Examples
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../usecases/" class="md-nav__link">
        Use Cases
      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#setting-up-vaccert-for-the-host" class="md-nav__link">
    Setting up vAccert for the host
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#build-qemu-with-vaccel-support" class="md-nav__link">
    Build QEMU with vAccel support
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#build-the-unikraft-application" class="md-nav__link">
    Build the Unikraft application
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#fire-it-up" class="md-nav__link">
    Fire it up!
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                
                  <h1>How to run a vAccel application using Unikraft</h1>
                
                <p>To run an image classification app in Unikraft using vAccel, we need:</p>
<ul>
<li>an NVIDIA GPU which supports CUDA </li>
<li>the appropriate device drivers</li>
<li><a href="https://github.com/dusty-nv/jetson-inference">jetson-inference</a></li>
</ul>
<p>As long as we have the above depedencies, we can proceed setting up the vAccel
environment for our example. A comprehensive walk through on installing the above dependencies is given in <a href="/jetson">Jetson-inference</a>. </p>
<p>Additionally, we will need to set up 3 components:</p>
<ul>
<li>The vAccel Runtime system, <a href="https://github.com/cloudkernels/vaccelrt">vAccelrt</a> on the bost</li>
<li>A hypervisor with vAccel support, in our case <a href="https://github.com/cloudkernels/qemu-vaccel/tree/vaccelrt_legacy_virtio">QEMU</a></li>
<li>and of course <a href="https://github.com/cloudkernels/unikraft/tree/vaccel_new">Unikraft</a></li>
</ul>
<p>To make things easier we have created some scripts and Docketfiles which
produce a vAccel enabled QEMU and a Unikraft unikernel. You can get them from
<a href="https://github.com/nubificus/qemu-x86-build/tree/unikernels_vaccelrt">this</a>
repo. The first 2 components can be built using the build.sh script with the -u
option, like:</p>
<pre><code>bash build.sh -u
</code></pre>
<p>The last component can be created using the build_guest.sh script with the -u option, like:</p>
<pre><code>bash build_guest.sh -u
</code></pre>
<p>After succefully building all components we can just fire up our unikernel
using the command:</p>
<pre><code>bash run.sh
</code></pre>
<p>This command will start Unikraft over QEMU classifying the image dog_0.jpg
under <code>guest/data/</code> directory of this repo.</p>
<p>Let's take a closer look on what is happening inside the containers and how we
can perform each step by ourselves.</p>
<h3 id="setting-up-vaccert-for-the-host">Setting up vAccert for the host</h3>
<p>vAccelrt is a thin and efficient runtime system that links against the user
application and is responsible for dispatching operations to the relevant
hardware accelerators. In our case the backend plugin will be an NVIDIA GPU,
and more specifically, jetson-inference, using TensorRT. As a result we need to
build the Jetson plugin for vAccelrt. </p>
<p>At first let's get the source code:</p>
<pre><code>git clone --recursive https://github.com/cloudkernels/vaccelrt.git
cd vaccelrt 
</code></pre>
<p>As we mentioned before, we will also build the jetson plugin and we will
specify <code>~/.local/</code> as the directory where vAccelrt will be installed.</p>
<pre><code>mkdir build &amp;&amp; cd build
cmake -DCMAKE_INSTALL_PREFIX=/.local -DBUILD_PLUGIN_JETSON=ON ..
make &amp;&amp; make Install
</code></pre>
<p>Now that we have vAccelrt installed we need to set the plugin that we will use</p>
<pre><code>export VACCEL_BACKENDS=/.local/lib/libvaccel-jetson.so
</code></pre>
<h3 id="build-qemu-with-vaccel-support">Build QEMU with vAccel support</h3>
<p>For the time being we have a seperated branch where QEMU exposes vAccel to the
guest with legacy virtio. First lets get the source code:</p>
<pre><code>git clone --recursive https://github.com/cloudkernels/qemu-vaccel.git -b vaccelrt_legacy_virtio
cd qemu-vaccel
</code></pre>
<p>We will configure QEMU with only one target and we need to point out the
install location of vAccelrt with cflags and ldflags. Please set the install
prefix in case you do not want it to be installed in the default directory.</p>
<pre><code>mkdir build &amp;&amp; cd build
../configure --extra-cflags=&quot;-I /.local/include&quot; --extra-ldflags=&quot;-L/.local/lib&quot; --target-list=x86_64-softmmu --enable-virtfs
make -j12 &amp;&amp; make install
</code></pre>
<p>THat's it. We are done with the host side!</p>
<h3 id="build-the-unikraft-application">Build the Unikraft application</h3>
<p>We will follow the instructions from <a href="http://docs.unikraft.org/users-advanced.html#">Unikraft's
documentation</a> with a minor
change. We will not use the official Unikraft repo but our fork. In our fork we
have added an example application for image classification.</p>
<pre><code>git clone https://github.com/cloudkernels/unikraft.git
mkdir apps/
cp -r unikraft/example apps/classify
cd apps/classify
</code></pre>
<p>Our example has a config which enables vAccel support for Unikraft and a lot of
debug messages. You can use that config or you can make your own config, but
make sure you select vaccelrt under library configuration inside menuconfig.</p>
<pre><code>cp vaccel_config .config &amp;&amp; make olddefconfig
make
</code></pre>
<p>After building is done, there will be a Unikraft image for KVM under the build directory.</p>
<h3 id="fire-it-up">Fire it up!</h3>
<p>After that long journey of building let's see what we have done. Not yet...</p>
<p>One more thing. We need to get the model which will be used for the image classification. We will use a script which is already provided by jetson-inference (normally under `/usr/local/share/jetson-inference/tools. Also we need to point vAccel's jetson plugin the path to that model.</p>
<pre><code>/path/to/download-models.sh
cp /usr/local/share/jetson-inference/data/networks/* networks
export VACCEL_IMAGENET_NETWORKS=/full/path/to/newly/downloaded/networks/directory
</code></pre>
<p>Finally we can run our unikernel using the command below:</p>
<pre><code>LD_LIBRARY_PATH=/.local/lib:/usr/local/nvidia/lib:/usr/local/nvidia/lib64 qemu-system-x86_64 -cpu host -m 512 -enable-kvm -nographic -vga none \
    -fsdev local,id=myid,path=/data/data,security_model=none -device virtio-9p-pci,fsdev=myid,mount_tag=data,disable-modern=on,disable-legacy=off \
    -object acceldev-backend-vaccelrt,id=gen0 -device virtio-accel-pci,id=accl0,runtime=gen0,disable-legacy=off,disable-modern=on \
    -kernel /data/classify_kvm-x86_64 -append &quot;vfs.rootdev=data -- dog_0.jpg 1&quot;
</code></pre>
<p>Let's highlight some parts of the qemu command:</p>
<ul>
<li><code>LD\_LIBRARY\_PATH</code> environment variable: QEMU will dynamically link with every library it needs and in this case it also needs the vAccelrt library</li>
<li><code>-fsdev local,id=myid,path=./data,security\_model=none</code>: We need to tell QEMU where will find the data that will pass to the guest. The data directory contains the image we want to classify</li>
<li><code>-object acceldev-backend-vaccelrt,id=gen0 -device virtio-accel-pci,id=accl0,runtime=gen0,disable-legacy=off,disable-modern=on</code>: For the vAccel driver</li>
<li><code>-append "vfs.rootdev=data -- dog_0.jpg 1"</code>: In the command line we need to tell the classify application which image to classify and how many iterations to do</li>
</ul>
                
                  
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid" aria-label="Footer">
        
          <a href="../../k8s/kata/" class="md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-footer-nav__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
            </div>
            <div class="md-footer-nav__title">
              <div class="md-ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                vAccel on k8s using Kata-containers & Firecracker
              </div>
            </div>
          </a>
        
        
          <a href="../../examples/" class="md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-footer-nav__title">
              <div class="md-ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                Examples
              </div>
            </div>
            <div class="md-footer-nav__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
          <div class="md-footer-copyright__highlight">
            Copyright &copy; 2018 - 2021 Nubificus LTD
          </div>
        
        Made with
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs
        </a>
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../../assets/javascripts/vendor.18f0862e.min.js"></script>
      <script src="../../assets/javascripts/bundle.994580cf.min.js"></script><script id="__lang" type="application/json">{"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing"}</script>
      
      <script>
        app = initialize({
          base: "../..",
          features: [],
          search: Object.assign({
            worker: "../../assets/javascripts/worker/search.9c0e82ba.min.js"
          }, typeof search !== "undefined" && search)
        })
      </script>
      
    
  </body>
</html>